# Carvel Package Supply Chains (Experimental)

The [Out of the Box Basic Supply Chain](ootb-supply-chain-basic.hbs.md) package
introduces a variation of the OOTB Basic supply chains that outputs Carvel
Packages. The Carvel Package Supply Chains enable users to easily deliver applications to multiple production environments with per-environment configuration.

This feature is **experimental** and has the following limitations:

1. Only the [Out of the Box Basic Supply Chain](ootb-supply-chain-basic.hbs.md) package is supported. The Testing and Scanning supply chains are not supported.
2. Only workloads of type `server` are supported.
3. Innerloop development is not supported.
4. Azure GitOps repositories are not supported.

This document explains what the Carvel Package Supply Chains do, how they work, how to enable them as an operator, and how to create a `Workload` that uses them.

## Understanding the Carvel Package Supply Chains

The traditional Out of the Box Supply Chain Basic Supply Chains outputs a `Deliverable` object. These `Deliverable`s are deployed to a cluster by the Out of the Box Delivery Supply Chain. In contrast, the Carvel Package Supply Chains output a Carvel `Package` object to a GitOps repository. These `Packages` have configurable parameters such as `hostname` and `replicas` that can be configured per environment. GitOps tools such as FluxCD and ArgoCD can then be used to deploy the `Package`s onto multiple environments.

> **Note:** The underlying Kubernetes resources created for your `server` `Workload` (e.g. `Deployment`) are the same as they would be for `source-to-url` or `basic-image-to-url`, but with the addition of a `networking.k8s.io/v1 Ingress` resource. The Carvel `Package` wraps these resources.

### What do the Carvel Package Supply Chains Do?

There are two Carvel Package Supply Chains, `source-to-url-package` and `basic-image-to-url-package` in the Out of the Box Supply Chain Package. They are identical to `source-to-url` and `basic-image-to-url`, respectively, except for three resources:
- A new resource `carvel-package` has been added. It stamps out a Tekton Task that bundles all application Kubernetes resources into a Carvel `Package`.
- `config-writer` has been modified to write the Carvel `Package` to a GitOps repo.
- `deliverable` resource has been removed.

When a `Workload` is created and all Supply Chain resources are successfully stamped out, a Carvel `Package` will be written to the GitOps repository at the path `<package_name>/packages/<package_id>.yaml`. 
- `<package_name>` defaults to `<workload_name>.<workload_namespace>.tap`, and can be customized with the `name_suffix` parameter (see below). 
- `<package_id>` is a SemVer compatible version generated by the Bash command `$(date "+%Y%m%d%H%M%S.0.0")`.

For example:

```
app.default.tap/
  packages/
    20230321004057.0.0.yaml
```

>**Note:** By default, the `<package_name>` directory will be created in the root directory of the GitOps repository. You can optionally create this directory at a subpath by configuring the `gitops_subpath` parameter (see below).

The Carvel `Package` definition, stored in `<package_id>.yaml` will look like this:

```yaml
apiVersion: data.packaging.carvel.dev/v1alpha1
kind: Package
metadata:
  name: app.default.tap.20230321004057.0.0
spec:
  refName: app.default.tap
  version: 20230321004057.0.0
  releaseNotes: |
    Release v20230321004057.0.0 of package app.default.tap
  template:
    spec:
      fetch:
      - imgpkgBundle:
          image: # imgpkg bundle containing all Kubernetes configuration
      template:
      - ytt:
          paths:
          - .
      - kbld:
          paths:
          - .imgpkg/images.yml
          - '-'
      deploy:
      - kapp: {}
```

The Carvel `Package` generated by the Supply Chain will have three configurable parameters:
- `replicas`: Number of desired pods for the `apps/v1 Deployment`. Default is `1`.
- `hostname`: Hostname for the `networking.k8s.io/v1 Ingress`. Default is `example.com`.
- `port`: Port for the `networking.k8s.io/v1 Ingress`. Default is `8080`.

When a new commit is pushed to the source code Git Repository (`source-to-url-package`), or a new pre-built image is created (`basic-image-to-url-package`), the Supply Chain will stamp out a new version of the Carvel `Package`. This definition will be written to `<package_name>/packages/<package_id>.yaml`, but with a new `<package_id>`.

Carvel `Package`s stored in GitOps repositories can be deployed to multiple run clusters using GitOps tools such as FluxCD or ArgoCD. See [Deploy Carvel Packages using FluxCD Kustomization](delivery-with-flux.hbs.md) as an example.

## <a id='carvel-package-operator'></a> Installing the Carvel Package Supply Chains as an Operator

This section describes operator tasks for enabling and configuring the Carvel Package Supply Chains.

### Prerequisites

The Carvel Package Supply Chains require access to a GitOps repository and credentials. See [GitOps versus RegistryOps](gitops-vs-regops.hbs.md#gitops).

### Installation

In `tap-values`, configure the [Out of the Box Basic Supply Chain](ootb-supply-chain-basic.hbs.md) package with the following parameters:

1. (Required) Enable the Carvel Package workflow.

    ```yaml
    ootb_supply_chain_basic:
      carvel_package:
        workflow_enabled: true
    ```

2. (Optional) Set a GitOps subpath. This will determine the path in your GitOps repository to which Carvel Packages are written. Defaults to `""`. See the [Carvel Package template](ootb-template-reference.hbs.md#carvel) for more information.

    ```yaml
    ootb_supply_chain_basic:
      carvel_package:
        workflow_enabled: true
        gitops_subpath: path/to/my/dir
    ```

3. (Optional) Set a name suffix. Carvel Package names will be chosen using the template `<workload_name>.<workload_namespace>.<name_suffix>`. Defaults to `tap`. See the [Carvel Package template](ootb-template-reference.hbs.md#carvel) for more information.

    ```yaml
    ootb_supply_chain_basic:
      carvel_package:
        workflow_enabled: true
        name_suffix: vmware.com
    ```

4. Configure the [Out of the Box Basic Supply Chain](ootb-supply-chain-basic.hbs.md) package with your GitOps parameters, as described in [GitOps versus RegistryOps](gitops-vs-regops.hbs.md#gitops).

5. Install the [Out of the Box Basic Supply Chain](ootb-supply-chain-basic.hbs.md) package.

### Verifying the Carvel Package Supply Chains are Installed

1. Run `kubectl get ClusterSupplyChains`.
2. Confirm you see both `source-to-url-package` and `basic-image-to-url-package` with status `Ready: True`.

## <a id='carvel-package-developer'></a> Using the Carvel Package Supply Chains as a Developer

This section describes developer tasks for using the Carvel Package Supply Chains.

### Prerequisites

Your operator must [install the Carvel Package Supply Chains](#carvel-package-operator).

### Creating a Workload

To use the Carvel Package Supply Chains, you must add the label `apps.tanzu.vmware.com/carvel-package-workflow=true` to your workload.

Use the following Tanzu CLI flag:

- `--label apps.tanzu.vmware.com/carvel-package-workflow=true`

For example:

  ```bash
  tanzu apps workload create tanzu-java-web-app \
    --app tanzu-java-web-app \
    --type server \
    --label apps.tanzu.vmware.com/carvel-package-workflow=true \
    --image IMAGE
  ```

Expect to see the following output:

  ```console
  Create workload:
      1 + |---
      2 + |apiVersion: carto.run/v1alpha1
      3 + |kind: Workload
      4 + |metadata:
      5 + |  labels:
      6 + |    app.kubernetes.io/part-of: tanzu-java-web-app
      7 + |    apps.tanzu.vmware.com/carvel-package-workflow: "true"
      8 + |    apps.tanzu.vmware.com/workload-type: server
      9 + |  name: tanzu-java-web-app
     10 + |  namespace: default
     11 + |spec:
     12 + |  image: IMAGE
  ```

(Optional) You can override parameters set by the operator:

1. (Optional) Set a GitOps subpath. This will determine the path in your GitOps repository to which Carvel Packages are written. Defaults to `""`. See the [Carvel Package template](ootb-template-reference.hbs.md#carvel) for more information.

    Set this parameter by modifying `workload.spec.params.carvel_package_gitops_subpath`. With the Tanzu CLI, you can do so by using the following flag:

    - `--param carvel_package_gitops_subpath=path/to/my/dir`

2. (Optional) Set a name suffix. Carvel Package names will be chosen using the template `<workload_name>.<workload_namespace>.<name_suffix>`. Defaults to `tap`. See the [Carvel Package template](ootb-template-reference.hbs.md#carvel) for more information.

    Set this parameter by modifying `workload.spec.params.carvel_package_name_suffix`. With the Tanzu CLI, you can do so by using the following flag:

      - `--param carvel_package_name_suffix=vmware.com`

3. (Optional) You can override GitOps parameters as described in [GitOps versus RegistryOps](gitops-vs-regops.hbs.md#gitops).

### Verify the Carvel Package was Created

You should now see a Carvel `Package` stored in your GitOps repository. For example, at the path `tanzu-java-web-app.default.tap/packages/20230321004057.0.0.yaml` you should see a valid Carvel `Package` definition.

### Next Steps

You can deploy the Carvel `Package` above using tools such as FluxCD or ArgoCD. See [Deploy Carvel Packages using FluxCD Kustomization](delivery-with-flux.hbs.md) as an example.